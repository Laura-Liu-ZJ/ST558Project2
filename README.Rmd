---
title: "Project2"
author: "Zhijun Liu"
date: "`r Sys.Date()`"
output:  
  rmarkdown::github_document:  
    toc: TRUE
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = FALSE,warning = FALSE)
```

```{r library}
# prepare for the packages
library(readr)
library(tidyverse)
library(corrplot)
library(ggplot2)
library(leaps)
library(caret)
```

# Introduction
## [Description of Data](https://archive.ics.uci.edu/ml/datasets/Online+News+Popularity)

This dataset summarizes a heterogeneous set of features about articles published by Mashable in a period of two years. The full dataset have 39644 observations and 61 variables. However, there are only 1 response and 8 predictors we interested due to the later variable selection. And following is the description of variables we cared about.

* Response:  
    + shares: Number of shares
* Predictors:  
    + num_hrefs: Number of links 
    + average_token_length: Average length of the words in the content 
    + data_channel_is_entertainment: Is data channel 'Entertainment'? 
    + kw_min_avg: Avg. keyword (min. shares)
    + kw_max_avg: Avg. keyword (max. shares)
    + kw_avg_avg: Avg. keyword (avg. shares) 
    + self_reference_min_shares: Min. shares of referenced articles in Mashable 
    + global_subjectivity: Text subjectivity 

## Analysis Purpose

In this project, I try to use a linear model and a non-linear model to predict the number of shares in social networks.

## Methods Introduction

### Linear Model
binomial
### treebag


# Exploratory Data Analysis

```{r readData}
newsData <- read_csv("data/OnlineNewsPopularity.csv")%>%
  filter(weekday_is_monday==1)%>%
  select(-1,-2)%>%
  mutate(sharesInd = ifelse(shares < 1400,0,1))
newsData

newsData$sharesInd <- as.factor(newsData$sharesInd)

anyNA(newsData)

# set seed to generate reproducable results
set.seed(1) 
# split raw data set into training data set and test data set
train <- sample(1:nrow(newsData), size = nrow(newsData)*0.7) 
test <- dplyr::setdiff(1:nrow(newsData), train)
newsDataTrain <- newsData[train, ] 
newsDataTest <- newsData[test, ]

# checking the dimension of our training and testing data sets
dim(newsDataTrain)
dim(newsDataTest)
```

## Response Analysis

From the histogram of response, we know that shares is more like a gamma distribution other than normal distribution.

```{r}
#newsDataTrain
ggplot(data=newsDataTrain,aes(x=shares)) +
  geom_histogram(aes(y=..density..),fill="steelblue")+
  geom_density(alpha=0.5)+
  labs(title = "Histogram of Respose")
ggplot(data=newsDataTrain %>%
         filter(sharesInd == 1),
       aes(x=shares)) +
  geom_histogram(aes(y=..density..),fill="steelblue")+
  geom_density(alpha=0.5)+
  labs(title = "Histogram of Respose (shares >= 1400)")
ggplot(data=newsDataTrain %>%
         filter(sharesInd == 0),
       aes(x=shares)) +
  geom_histogram(aes(y=..density..),fill="steelblue")+
  geom_density(alpha=0.5)+
  labs(title = "Histogram of Respose (shares < 1400)")
```

```{r}
orgAccuracyTrain <- round(table(newsDataTrain$sharesInd)[2]/nrow(newsDataTrain),4)
orgAPERTrain <- 1-orgAccuracyTrain
orgAccuracyTest <- round(table(newsDataTest$sharesInd)[2]/nrow(newsDataTest),4)
orgAPERTest <- 1-orgAccuracyTest
```

## Variables Selection

```{r}
library(leaps)
# variables selection process
all<-regsubsets(sharesInd~., 
                data=newsDataTrain %>% select(-shares), 
                nbest=1, really.big=T)
info <- summary(all)
# combine the information of some marks
selectData<-cbind(info$which, round(cbind(rsq=info$rsq, 
                              adjr2=info$adjr2,
                              cp=info$cp,
                              bic=info$bic, 
                              rss=info$rss), 3)) %>% 
  tbl_df() %>% arrange(bic)

# get the variables' name from above result
varName <- colnames(selectData)[which(selectData[1,] == 1)][-1]
varName

# generate the data set only from above results
newsDataFit <- newsDataTrain %>%
  select(sharesInd,contains(varName))
```


## Predictors Analysis

```{r}
summary(newsDataFit[,-1])
library(GGally)

ggpairs(newsDataFit,
        aes(colour = sharesInd,alpha=0.4),
        upper = "blank",
        lower = list(continuous = wrap("smooth",
                                       alpha = 0.3,
                                       size=0.01)))
```

# Model Fitting

## Linear Model

We would expect most of our predictors pass the F-test.

```{r}
linearModel <- glm(sharesInd ~ .,newsDataFit,family="binomial")
summary(linearModel)
# predict reponse by fitting model
linearTrainPred <- ifelse(exp(predict(linearModel, newdata = newsDataFit,type="link"))<1,0,1)
# Corss validation
linearFit <- confusionMatrix(as.factor(linearTrainPred), newsDataFit$sharesInd)
linearFit
linearFit$overall[1]
```

## Non-linear Model

```{r}
# set seed to get a reproducable result
set.seed(1)
# fit the bagged tree model
treebagFit <- train(sharesInd ~ ., 
                    data = newsDataFit, 
                    method = "treebag", 
                    tuneLength = 10,
                    preProcess = c("center", "scale"))
# get the fit result
treebagFit
```


# Model Testing

## Linear Model

```{r}
# predict reponse by fitting model
linearTestPred <- ifelse(exp(predict(linearModel, newdata = newsDataTest,type="link"))<1,0,1)
# Corss validation
library(caret)
linearResult <- confusionMatrix(as.factor(linearTestPred), newsDataTest$sharesInd)
linearResult
```

## Non-linear Model
```{r}
# predict reponse by fitting model
treebagTestPred <- predict(treebagFit, newdata = newsDataTest)
# Corss validation
treebagResult <- confusionMatrix(treebagTestPred, newsDataTest$sharesInd)
treebagResult
```

# Models Comparison

```{r}
Accuracytable<- round(data.frame(Train=rbind(linearFit$overall[1],
                                             treebagFit$results$Accuracy,
                                             orgAccuracyTrain),
                                 Test = rbind(linearResult$overall[1],
                                              treebagResult$overall[1],
                                              orgAccuracyTest),
                                 row.names = c("Linear Model",
                                               "Non-linear Model",
                                               "Original Data")
                                 ),4)
APERtable <- 1-Accuracytable
library(knitr)
kable(Accuracytable,
      row.names=TRUE,
      col.names = c("Train","Test"),
      caption = "Accuracy Table")
kable(APERtable,
      row.names=TRUE,
      col.names = c("Train","Test"),
      caption = "APER Table")
```

